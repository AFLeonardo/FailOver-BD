<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Failover MySQL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS por CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      border-radius: 9999px;
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">

    <!-- HEADER -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Dashboard Failover MySQL</h1>
        <p class="text-slate-400 text-sm">
          Estado en tiempo real del sistema (solo /status).
        </p>
      </div>

      <div class="flex items-center gap-3">
        <span id="last-refresh" class="text-xs text-slate-500">Última actualización: —</span>

        <button id="refresh-btn"
          class="inline-flex items-center gap-1 rounded-full border border-sky-500/60 bg-sky-500/10 px-3 py-1.5 text-xs font-medium text-sky-100 hover:bg-sky-500/20 active:scale-95 transition">
          Actualizar
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10" />
            <polyline points="1 20 1 14 7 14" />
            <path
              d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
          </svg>
        </button>
      </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="grid gap-6 grid-cols-1 sm:grid-cols-2">

      <!-- PRIMARY -->
      <div
        class="rounded-2xl border border-emerald-500/40 bg-gradient-to-br from-emerald-500/15 via-emerald-500/5 to-slate-900 p-5 shadow-lg shadow-slate-900/40">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-semibold uppercase tracking-widest text-emerald-200">Primary node</h2>
          <span class="inline-block h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_6px] shadow-emerald-400"></span>
        </div>

        <p id="primary-node" class="mt-3 text-xl font-bold text-emerald-50 truncate">—</p>
        <p class="text-xs text-emerald-100/70 mt-1">Nodo actual de escritura</p>
      </div>

      <!-- REPLICA -->
      <div
        class="rounded-2xl border border-sky-500/40 bg-gradient-to-br from-sky-500/15 via-sky-500/5 to-slate-900 p-5 shadow-lg shadow-slate-900/40">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-semibold uppercase tracking-widest text-sky-200">Replica node</h2>
          <span class="inline-block h-2 w-2 rounded-full bg-sky-400 shadow-[0_0_6px] shadow-sky-400"></span>
        </div>

        <p id="replica-node" class="mt-3 text-xl font-bold text-sky-50 truncate">—</p>
        <p class="text-xs text-sky-100/70 mt-1">Nodo en modo read_only</p>
      </div>

    </main>

    <!-- CUADRO INFORMATIVO -->
    <section
      class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 shadow-lg shadow-slate-900/40 space-y-3">
      <h3 class="text-xs font-semibold uppercase tracking-widest text-slate-400">Información del último evento</h3>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <p class="text-xs text-slate-400 uppercase tracking-widest">Último tipo</p>
          <p id="last-event-type" class="mt-1 text-sm font-medium text-slate-100">—</p>
        </div>

        <div>
          <p class="text-xs text-slate-400 uppercase tracking-widest">Fecha/Hora</p>
          <p id="last-event-time" class="mt-1 text-sm text-slate-200">—</p>
        </div>
      </div>

      <p class="text-[11px] text-slate-500">
        * Información proveniente de /status (failover o recovery más reciente).
      </p>
    </section>

  </div>

  <!-- SCRIPT -->
  <script>
    const primaryNodeEl = document.getElementById("primary-node");
    const replicaNodeEl = document.getElementById("replica-node");
    const lastEventTypeEl = document.getElementById("last-event-type");
    const lastEventTimeEl = document.getElementById("last-event-time");
    const lastRefreshEl = document.getElementById("last-refresh");
    const refreshBtn = document.getElementById("refresh-btn");

    function formatDateTime(dateString) {
      if (!dateString) return "—";
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return dateString;
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    async function fetchStatus() {
      try {
        const res = await fetch("/status");
        if (!res.ok) throw new Error("Error consultando /status");

        const data = await res.json();

        const primary = data.primary_node ?? data.primary ?? "—";
        const replica = data.replica_node ?? data.replica ?? "—";

        primaryNodeEl.textContent = primary;
        replicaNodeEl.textContent = replica;

        lastEventTypeEl.textContent = data.event_type ?? "—";

        const t = data.last_failover || data.last_event_time || data.last_recovery;
        lastEventTimeEl.textContent = t ? formatDateTime(t) : "—";

      } catch (e) {
        primaryNodeEl.textContent = "Error";
        replicaNodeEl.textContent = "Error";
        lastEventTypeEl.textContent = "Error backend";
      }
    }

    function updateRefreshTimestamp() {
      const now = new Date();
      lastRefreshEl.textContent = "Última actualización: " + formatDateTime(now.toISOString());
    }

    async function refresh() {
      await fetchStatus();
      updateRefreshTimestamp();
    }

    refreshBtn.addEventListener("click", refresh);

    // Auto-refresh cada 10s
    setInterval(refresh, 10000);

    // Primer render
    refresh();
  </script>

</body>
</html>
