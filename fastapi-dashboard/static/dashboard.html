<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Failover MySQL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind config + CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
        darkMode: "class"
    };
  </script>

  <style>
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      border-radius: 9999px;
    }

    @keyframes fade-in-up {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-card {
      animation: fade-in-up 0.4s ease-out;
    }

    @keyframes fade-in-row {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .row-enter {
        animation: fade-in-row 0.25s ease-out;
    }

  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">
  <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">

    <!-- HEADER -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between animate-card">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Dashboard Failover MySQL</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm">
          Estado en tiempo real del sistema (endpoint:
          <span class="font-mono text-sky-600 dark:text-sky-300">/status</span>).
        </p>
      </div>

      <div class="flex items-center gap-3">
        <!-- Theme toggle -->
        <button id="theme-toggle"
          class="inline-flex items-center gap-1 rounded-full border border-slate-300 bg-slate-100 px-3 py-1.5 text-xs font-medium text-slate-800 shadow-sm hover:bg-slate-200 active:scale-95 transition
                 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:hover:bg-slate-800">
          <span id="theme-icon" class="inline-flex">
            <!-- icono se rellena por JS (â˜€ï¸ / ðŸŒ™) -->
          </span>
          <span id="theme-label">Modo oscuro</span>
        </button>

        <div class="flex flex-col items-end gap-1">
          <span id="last-refresh" class="text-xs text-slate-500 dark:text-slate-400">
            Ãšltima actualizaciÃ³n: â€”
          </span>

          <button id="refresh-btn"
            class="inline-flex items-center gap-1 rounded-full border border-sky-500/60 bg-sky-500/10 px-3 py-1.5 text-xs font-medium text-sky-800 hover:bg-sky-500/20 active:scale-95 transition disabled:opacity-60 disabled:cursor-not-allowed
                   dark:text-sky-100">
            <span id="refresh-label">Actualizar</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 4 23 10 17 10" />
              <polyline points="1 20 1 14 7 14" />
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- CARDS PRIMARY / REPLICA -->
    <main class="grid gap-6 grid-cols-1 sm:grid-cols-2">
      <!-- PRIMARY -->
      <section
        class="animate-card rounded-2xl border border-emerald-300 bg-gradient-to-br from-emerald-100 via-emerald-50 to-white p-5 shadow-md shadow-emerald-100/60 transition-transform transition-shadow duration-300 hover:-translate-y-0.5 hover:shadow-xl
               dark:border-emerald-500/40 dark:from-emerald-500/15 dark:via-emerald-500/5 dark:to-slate-900 dark:shadow-slate-900/40"
        aria-label="Nodo primary">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-semibold uppercase tracking-widest text-emerald-700 dark:text-emerald-200">
            Primary node
          </h2>
          <span
            class="inline-block h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_6px] shadow-emerald-400"></span>
        </div>

        <p id="primary-node" class="mt-3 text-xl font-bold text-emerald-900 dark:text-emerald-50 truncate">â€”</p>
        <p class="text-xs text-emerald-800/80 dark:text-emerald-100/70 mt-1">
          Nodo actual de escritura
        </p>
      </section>

      <!-- REPLICA -->
      <section
        class="animate-card rounded-2xl border border-sky-300 bg-gradient-to-br from-sky-100 via-sky-50 to-white p-5 shadow-md shadow-sky-100/60 transition-transform transition-shadow duration-300 hover:-translate-y-0.5 hover:shadow-xl
               dark:border-sky-500/40 dark:from-sky-500/15 dark:via-sky-500/5 dark:to-slate-900 dark:shadow-slate-900/40"
        aria-label="Nodo replica">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-semibold uppercase tracking-widest text-sky-700 dark:text-sky-200">
            Replica node
          </h2>
          <span class="inline-block h-2 w-2 rounded-full bg-sky-400 shadow-[0_0_6px] shadow-sky-400"></span>
        </div>

        <p id="replica-node" class="mt-3 text-xl font-bold text-sky-900 dark:text-sky-50 truncate">â€”</p>
        <p class="text-xs text-sky-800/80 dark:text-sky-100/70 mt-1">
          Nodo en modo read_only
        </p>
      </section>
    </main>

    <!-- INFO ÃšLTIMO EVENTO -->
    <section
      class="animate-card rounded-2xl border border-slate-200 bg-white/90 p-5 shadow-md shadow-slate-200/60 space-y-3 transition-transform transition-shadow duration-300 hover:-translate-y-0.5 hover:shadow-xl
             dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-900/40">
      <h3 class="text-xs font-semibold uppercase tracking-widest text-slate-500 dark:text-slate-400">
        InformaciÃ³n del Ãºltimo evento
      </h3>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-widest">
            Ãšltimo tipo
          </p>
          <p id="last-event-type" class="mt-1 text-sm font-medium text-slate-900 dark:text-slate-100">â€”</p>
        </div>

        <div>
          <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-widest">
            Fecha/Hora
          </p>
          <p id="last-event-time" class="mt-1 text-sm text-slate-800 dark:text-slate-200">â€”</p>
        </div>
      </div>

      <p class="text-[11px] text-slate-500 dark:text-slate-500">
        * InformaciÃ³n proveniente del Ãºltimo registro en
        <span class="font-mono text-sky-700 dark:text-sky-300">system_events</span> (campo
        <span class="font-mono text-sky-700 dark:text-sky-300">created_at</span>).
      </p>
    </section>

    <!-- HISTORIAL (Ãºltimos 10 registros) -->
    <section
      class="animate-card rounded-2xl border border-slate-200 bg-white/90 p-5 shadow-md shadow-slate-200/60 space-y-3 transition-transform transition-shadow duration-300 hover:-translate-y-0.5 hover:shadow-xl
             dark:border-slate-800 dark:bg-slate-900/70 dark:shadow-slate-900/40">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-xs font-semibold uppercase tracking-widest text-slate-500 dark:text-slate-400">
            Historial (Ãºltimos 10 registros)
          </h3>
          <p class="text-[11px] text-slate-500 dark:text-slate-500">
            Tabla <span class="font-mono text-sky-700 dark:text-sky-300">system_events</span>.
          </p>
        </div>
      </div>

      <div class="overflow-auto max-h-80 rounded-xl border border-slate-200 dark:border-slate-800">
        <table class="min-w-full text-xs">
          <thead class="bg-slate-100 dark:bg-slate-900/90 sticky top-0 z-10">
            <tr class="border-b border-slate-200 dark:border-slate-800/80">
              <th class="px-3 py-2 text-left font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-widest">#</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Tipo</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Primary</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Replica</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Fecha</th>
            </tr>
          </thead>
          <tbody id="history-body" class="divide-y divide-slate-200 dark:divide-slate-800/80">
            <tr>
              <td colspan="5" class="px-3 py-4 text-center text-slate-500 dark:text-slate-400">
                Cargando historial...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- SCRIPT -->
  <script>
    const primaryNodeEl = document.getElementById("primary-node");
    const replicaNodeEl = document.getElementById("replica-node");
    const lastEventTypeEl = document.getElementById("last-event-type");
    const lastEventTimeEl = document.getElementById("last-event-time");
    const lastRefreshEl = document.getElementById("last-refresh");
    const refreshBtn = document.getElementById("refresh-btn");
    const refreshLabelEl = document.getElementById("refresh-label");
    const historyBodyEl = document.getElementById("history-body");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const themeLabelEl = document.getElementById("theme-label");
    const themeIconEl = document.getElementById("theme-icon");
    const root = document.documentElement;

    function formatDateTime(dateString) {
      if (!dateString) return "â€”";
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return String(dateString);
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function setRefreshing(isLoading) {
      refreshBtn.disabled = isLoading;
      refreshLabelEl.textContent = isLoading ? "Actualizando..." : "Actualizar";
    }

    function renderHistory(history) {
      if (!Array.isArray(history) || history.length === 0) {
        historyBodyEl.innerHTML = `
          <tr>
            <td colspan="5" class="px-3 py-4 text-center text-slate-500 dark:text-slate-400">
              No hay registros en system_events.
            </td>
          </tr>
        `;
        return;
      }

      historyBodyEl.innerHTML = "";

      history.forEach((ev, idx) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/60 transition-colors";
        tr.style.animationDelay = `${idx * 40}ms`; 

        const type = ev.event_type ?? "N/A";
        const primary = ev.primary_node ?? "â€”";
        const replica = ev.replica_node ?? "â€”";
        const created = ev.created_at ? formatDateTime(ev.created_at) : "â€”";

        let typeClasses = "bg-slate-200 text-slate-800 border border-slate-300";
        if (type === "FAILOVER") {
          typeClasses = "bg-amber-500/15 text-amber-800 border border-amber-400/40 dark:bg-amber-500/20 dark:text-amber-200 dark:border-amber-500/40";
        } else if (type === "RECOVERY") {
          typeClasses = "bg-emerald-500/15 text-emerald-800 border border-emerald-400/40 dark:bg-emerald-500/20 dark:text-emerald-200 dark:border-emerald-500/40";
        }

        tr.innerHTML = `
          <td class="px-3 py-2 text-[11px] text-slate-500 dark:text-slate-500">
            ${idx + 1}
          </td>
          <td class="px-3 py-2">
            <span class="inline-flex rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase tracking-widest ${typeClasses}">
              ${type}
            </span>
          </td>
          <td class="px-3 py-2 font-mono text-[11px] text-slate-800 dark:text-slate-100">
            ${primary}
          </td>
          <td class="px-3 py-2 font-mono text-[11px] text-slate-800 dark:text-slate-100">
            ${replica}
          </td>
          <td class="px-3 py-2 text-[11px] text-slate-700 dark:text-slate-300">
            ${created}
          </td>
        `;

        historyBodyEl.appendChild(tr);
      });
    }

    async function fetchStatus() {
      const res = await fetch("/status");
      if (!res.ok) throw new Error("Error consultando /status");
      return res.json();
    }

    function updateRefreshTimestamp() {
      const now = new Date();
      lastRefreshEl.textContent =
        "Ãšltima actualizaciÃ³n: " + formatDateTime(now.toISOString());
    }

    async function refresh() {
      try {
        setRefreshing(true);
        const data = await fetchStatus();

        const primary = data.primary_node ?? data.primary ?? "â€”";
        const replica = data.replica_node ?? data.replica ?? "â€”";

        primaryNodeEl.textContent = primary;
        replicaNodeEl.textContent = replica;

        lastEventTypeEl.textContent = data.event_type ?? "â€”";

        const t = data.created_at;
        lastEventTimeEl.textContent = t ? formatDateTime(t) : "â€”";

        renderHistory(data.history || []);
        updateRefreshTimestamp();
      } catch (e) {
        console.error(e);
        primaryNodeEl.textContent = "Error";
        replicaNodeEl.textContent = "Error";
        lastEventTypeEl.textContent = "Error backend";
        lastEventTimeEl.textContent = "â€”";
        renderHistory([]);
      } finally {
        setRefreshing(false);
      }
    }

    // THEME HANDLING ðŸŒ—
    function applyTheme(theme) {
      if (theme === "dark") {
        root.classList.add("dark");
        themeLabelEl.textContent = "Modo claro";
        themeIconEl.textContent = "ðŸŒ™";
      } else {
        root.classList.remove("dark");
        themeLabelEl.textContent = "Modo oscuro";
        themeIconEl.textContent = "â˜€ï¸";
      }
    }

    function initTheme() {
      const stored = localStorage.getItem("theme");
      if (stored === "dark" || stored === "light") {
        applyTheme(stored);
        return;
      }
      const prefersDark = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      applyTheme(prefersDark ? "dark" : "light");
    }

    themeToggleBtn.addEventListener("click", () => {
      const isDark = root.classList.contains("dark");
      const nextTheme = isDark ? "light" : "dark";
      applyTheme(nextTheme);
      localStorage.setItem("theme", nextTheme);
    });

    // Auto-refresh y primer render
    refreshBtn.addEventListener("click", refresh);
    setInterval(refresh, 10000);
    initTheme();
    refresh();
  </script>

</body>
</html>
