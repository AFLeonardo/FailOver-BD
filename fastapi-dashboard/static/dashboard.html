<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Failover MySQL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS por CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      border-radius: 9999px;
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">

    <!-- HEADER -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Dashboard Failover MySQL</h1>
        <p class="text-slate-400 text-sm">
          Estado en tiempo real del sistema (endpoint:
          <span class="font-mono text-sky-300">/status</span>).
        </p>
      </div>

      <div class="flex items-center gap-3">
        <span id="last-refresh" class="text-xs text-slate-500">
          Última actualización: —
        </span>

        <button id="refresh-btn"
          class="inline-flex items-center gap-1 rounded-full border border-sky-500/60 bg-sky-500/10 px-3 py-1.5 text-xs font-medium text-sky-100 hover:bg-sky-500/20 active:scale-95 transition disabled:opacity-60 disabled:cursor-not-allowed">
          <span id="refresh-label">Actualizar</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10" />
            <polyline points="1 20 1 14 7 14" />
            <path
              d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
          </svg>
        </button>
      </div>
    </header>

    <!-- CARDS PRIMARY / REPLICA -->
    <main class="grid gap-6 grid-cols-1 sm:grid-cols-2">

      <!-- PRIMARY -->
      <section
        class="rounded-2xl border border-emerald-500/40 bg-gradient-to-br from-emerald-500/15 via-emerald-500/5 to-slate-900 p-5 shadow-lg shadow-slate-900/40"
        aria-label="Nodo primary">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-semibold uppercase tracking-widest text-emerald-200">Primary node</h2>
          <span class="inline-block h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_6px] shadow-emerald-400"></span>
        </div>

        <p id="primary-node" class="mt-3 text-xl font-bold text-emerald-50 truncate">—</p>
        <p class="text-xs text-emerald-100/70 mt-1">Nodo actual de escritura</p>
      </section>

      <!-- REPLICA -->
      <section
        class="rounded-2xl border border-sky-500/40 bg-gradient-to-br from-sky-500/15 via-sky-500/5 to-slate-900 p-5 shadow-lg shadow-slate-900/40"
        aria-label="Nodo replica">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-semibold uppercase tracking-widest text-sky-200">Replica node</h2>
          <span class="inline-block h-2 w-2 rounded-full bg-sky-400 shadow-[0_0_6px] shadow-sky-400"></span>
        </div>

        <p id="replica-node" class="mt-3 text-xl font-bold text-sky-50 truncate">—</p>
        <p class="text-xs text-sky-100/70 mt-1">Nodo en modo read_only</p>
      </section>

    </main>

    <!-- INFO ÚLTIMO EVENTO -->
    <section
      class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 shadow-lg shadow-slate-900/40 space-y-3">
      <h3 class="text-xs font-semibold uppercase tracking-widest text-slate-400">
        Información del último evento
      </h3>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <p class="text-xs text-slate-400 uppercase tracking-widest">Último tipo</p>
          <p id="last-event-type" class="mt-1 text-sm font-medium text-slate-100">—</p>
        </div>

        <div>
          <p class="text-xs text-slate-400 uppercase tracking-widest">Fecha/Hora</p>
          <p id="last-event-time" class="mt-1 text-sm text-slate-200">—</p>
        </div>
      </div>

      <p class="text-[11px] text-slate-500">
        * Información proveniente del último registro en
        <span class="font-mono text-sky-300">system_events</span> (campo
        <span class="font-mono text-sky-300">created_at</span>).
      </p>
    </section>

    <!-- HISTORIAL (últimos 10 registros) -->
    <section
      class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-lg shadow-slate-900/40 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-xs font-semibold uppercase tracking-widest text-slate-400">
            Historial (últimos 10 registros)
          </h3>
          <p class="text-[11px] text-slate-500">
            Tabla <span class="font-mono text-sky-300">system_events</span>.
          </p>
        </div>
      </div>

      <div class="overflow-auto max-h-80 rounded-xl border border-slate-800">
        <table class="min-w-full text-xs">
          <thead class="bg-slate-900/90 sticky top-0 z-10">
            <tr class="border-b border-slate-800/80">
              <th class="px-3 py-2 text-left font-semibold text-slate-400 uppercase tracking-widest">#</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-400 uppercase tracking-widest">Tipo</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-400 uppercase tracking-widest">Primary</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-400 uppercase tracking-widest">Replica</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-400 uppercase tracking-widest">Fecha</th>
            </tr>
          </thead>
          <tbody id="history-body" class="divide-y divide-slate-800/80">
            <tr>
              <td colspan="5" class="px-3 py-4 text-center text-slate-400">
                Cargando historial...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- SCRIPT -->
  <script>
    const primaryNodeEl = document.getElementById("primary-node");
    const replicaNodeEl = document.getElementById("replica-node");
    const lastEventTypeEl = document.getElementById("last-event-type");
    const lastEventTimeEl = document.getElementById("last-event-time");
    const lastRefreshEl = document.getElementById("last-refresh");
    const refreshBtn = document.getElementById("refresh-btn");
    const refreshLabelEl = document.getElementById("refresh-label");
    const historyBodyEl = document.getElementById("history-body");

    function formatDateTime(dateString) {
      if (!dateString) return "—";
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return String(dateString);
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function setRefreshing(isLoading) {
      refreshBtn.disabled = isLoading;
      refreshLabelEl.textContent = isLoading ? "Actualizando..." : "Actualizar";
    }

    function renderHistory(history) {
      if (!Array.isArray(history) || history.length === 0) {
        historyBodyEl.innerHTML = `
          <tr>
            <td colspan="5" class="px-3 py-4 text-center text-slate-400">
              No hay registros en system_events.
            </td>
          </tr>
        `;
        return;
      }

      historyBodyEl.innerHTML = "";

      history.forEach((ev, idx) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/60 transition";

        const type = ev.event_type ?? "N/A";
        const primary = ev.primary_node ?? "—";
        const replica = ev.replica_node ?? "—";
        const created = ev.created_at ? formatDateTime(ev.created_at) : "—";

        let typeClasses = "bg-slate-700 text-slate-100";
        if (type === "FAILOVER") {
          typeClasses = "bg-amber-500/20 text-amber-200 border border-amber-500/40";
        } else if (type === "RECOVERY") {
          typeClasses = "bg-emerald-500/20 text-emerald-200 border border-emerald-500/40";
        }

        tr.innerHTML = `
          <td class="px-3 py-2 text-[11px] text-slate-500">
            ${idx + 1}
          </td>
          <td class="px-3 py-2">
            <span class="inline-flex rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase tracking-widest ${typeClasses}">
              ${type}
            </span>
          </td>
          <td class="px-3 py-2 font-mono text-[11px] text-slate-100">
            ${primary}
          </td>
          <td class="px-3 py-2 font-mono text-[11px] text-slate-100">
            ${replica}
          </td>
          <td class="px-3 py-2 text-[11px] text-slate-300">
            ${created}
          </td>
        `;

        historyBodyEl.appendChild(tr);
      });
    }

    async function fetchStatus() {
      const res = await fetch("/status");
      if (!res.ok) throw new Error("Error consultando /status");
      return res.json();
    }

    function updateRefreshTimestamp() {
      const now = new Date();
      lastRefreshEl.textContent =
        "Última actualización: " + formatDateTime(now.toISOString());
    }

    async function refresh() {
      try {
        setRefreshing(true);
        const data = await fetchStatus();

        const primary = data.primary_node ?? data.primary ?? "—";
        const replica = data.replica_node ?? data.replica ?? "—";

        primaryNodeEl.textContent = primary;
        replicaNodeEl.textContent = replica;

        lastEventTypeEl.textContent = data.event_type ?? "—";

        const t = data.created_at;
        lastEventTimeEl.textContent = t ? formatDateTime(t) : "—";

        renderHistory(data.history || []);
        updateRefreshTimestamp();
      } catch (e) {
        console.error(e);
        primaryNodeEl.textContent = "Error";
        replicaNodeEl.textContent = "Error";
        lastEventTypeEl.textContent = "Error backend";
        lastEventTimeEl.textContent = "—";
        renderHistory([]);
      } finally {
        setRefreshing(false);
      }
    }

    refreshBtn.addEventListener("click", refresh);
    setInterval(refresh, 10000);  // auto-refresh cada 10s
    refresh();
  </script>

</body>
</html>
